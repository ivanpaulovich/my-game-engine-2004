<html>
<head>
<title>brInput.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><i>(*******************************************************)
(*                                                     *)
(*       Engine Paulovich DirectX                      *)
(*       Win32-DirectX API Unit                        *)
(*                                                     *)
(*       Copyright (c) 2003-2004, Ivan Paulovich       *)
(*                                                     *)
(*       iskatrek@hotmail.com  uin#89160524            *)
(*                                                     *)
(*       Unit: brInput                                 *)
(*                                                     *)
(*******************************************************)

</i></font><b>unit </b>brInput;

<b>interface

uses
  </b>Windows, DirectInput8, SysUtils;

<b>type

  </b>TTimedInput = <b>record
    </b>Time: dWord;
    Used: boolean;
  <b>end</b>;

  TInput = <b>class
  private
    </b>FHandle: HWnd;
    DI8: IDirectInput8;
    DIK8: IDirectInputDevice8;
    DIM8: IDirectInputDevice8;
    DIJ8: IDirectInputDevice8;
    DIMEvent: THandle;
    DIMou0Clicked: Boolean;
    DIMou1Clicked: Boolean;
    DIJ8Caps: TDIDevCaps;
    <b>function </b>EnumJoysticksCallback(Device: PDIDeviceInstance; Ref: Pointer): Integer;
    <b>function </b>EnumAxesCallback(<b>var </b>Device: TDIDeviceObjectInstance; Ref: Pointer): Integer;
  <b>public
    constructor </b>Create(Handle: HWnd; Keyboard, Mouse, Joystick: Boolean);
    <b>function </b>Run: Integer;
    <b>procedure </b>Clear;
    <b>function </b>InitializeMouse: Boolean;
    <b>function </b>InitializeJoystick: Boolean;
    <b>function </b>InitializeKeyboard: Boolean;
    <b>function </b>MouseAcquire(Acquire: Boolean): Boolean;
    <b>function </b>MouseState(<b>var </b>X, Y: LongInt; <b>var </b>Up0, Down0, DblClk0,
      Up1, Down1, DblClk1: Longint): Boolean;
    <b>function </b>JoystickState(<b>var </b>Data: TDIJoyState2): Boolean;
    <b>function </b>KeyboardAcquire(Acquire: Boolean): Boolean;
    <b>function </b>KeyboardState: Boolean;
    <b>function </b>KeyDown(Key: Byte): Boolean;
    <b>property </b>Handle: HWnd <b>read </b>FHandle;
  <b>end</b>;

<b>var
  </b>Input: TInput = <b>nil</b>;

<b>procedure </b>TimedInputReset(<b>var </b>Ti: TTimedInput);
<b>function </b>TimedInputRefresh(<b>var </b>Ti: TTimedInput; _Time, TimeOut: DWord;
  Condition: Boolean): Longint;

<b>implementation

uses
  </b>brForms;

<b>const
  </b>DIMBufSize = <font color="#000080">16</font>;
  DIMTimeOut = <font color="#000080">250</font>;

  DIJoyRange = <font color="#000080">32768</font>;

<b>var
  </b>DIMButSwapped: Boolean = False;
  DIM0Released: DWord = <font color="#000080">0</font>;
  DIM1Released: DWord = <font color="#000080">0</font>;

  DIKeyBuffer: <b>array</b>[<font color="#000080">0</font>..<font color="#000080">255</font>] <b>of </b>Byte;

<b>procedure </b>TimedInputReset(<b>var </b>Ti: TTimedInput);
<b>begin
  </b>Ti.Time := <font color="#000080">0</font>;
  Ti.Used := False;
<b>end</b>;

<b>function </b>TimedInputRefresh(<b>var </b>Ti: TTimedInput; _Time, TimeOut: DWord;
  Condition: Boolean): LongInt;

<b>begin
  </b>Result := <font color="#000080">0</font>;
  <b>if </b>(Ti.Time = <font color="#000080">0</font>) <b>and </b>(Condition) <b>then
  begin
    </b>Ti.Time := _Time;
    Exit;
  <b>end</b>;

  <b>if </b>Ti.Time &lt;&gt; <font color="#000080">0 </font><b>then
    if </b>Condition <b>then
    begin
      if </b>_Time - Ti.Time &gt;= Timeout <b>then
      begin
        </b>Ti.Used := true;
        <b>while </b>_Time - Ti.Time &gt;= Timeout <b>do
        begin
          </b>Inc(Result);
          Inc(Ti.Time, Timeout)
        <b>end</b>;
      <b>end</b>;
    <b>end
    else
    begin
      if not </b>Ti.Used <b>then
        </b>Inc(Result);
      Ti.Used := false;
      Ti.Time := <font color="#000080">0</font>;
    <b>end</b>;
<b>end</b>;

<b>function </b>GlobalEnumJoysticksCallback(Device: PDIDeviceInstance; Ref: Pointer): Integer; <b>stdcall</b>;
<b>begin
  </b>Input.EnumJoysticksCallback(Device, Ref);
<b>end</b>;

<b>function </b>GlobalEnumAxesCallback(<b>var </b>Device: TDIDeviceObjectInstance; Ref: pointer): Integer; <b>stdcall</b>;
<b>begin
  </b>Input.EnumAxesCallback(Device, Ref);
<b>end</b>;

<b>constructor </b>TInput.Create;
<b>begin
  if </b>Assigned(Input) <b>then
    raise </b>ELogError.Create(Format(ERROR_EXISTS, [<font color="#000080">'TInput'</font>]))
  <b>else
    </b>SaveLog(Format(EVENT_CREATE, [<font color="#000080">'TInput'</font>]));
  DI8 := <b>nil</b>;
  DIK8 := <b>nil</b>;
  DIM8 := <b>nil</b>;
  DIJ8 := <b>nil</b>;
  FHandle := Handle;
<b>end</b>;

<b>function </b>TInput.Run: Integer;
<b>begin
  </b>Clear;

  SaveLog(Format(EVENT_TALK, [<font color="#000080">'TInput.Run'</font>]));

  <b>if </b>Failed(DirectInput8Create(hInstance, DIRECTINPUT_VERSION, IID_IDirectInput8,
    DI8, <b>nil</b>)) <b>then
    </b>Result := E_FAIL
  <b>else
    </b>Result := S_OK;
<b>end</b>;

<b>procedure </b>TInput.Clear;
<b>begin
  if </b>Assigned(DI8) <b>then
  begin
    if </b>Assigned(DIK8) <b>then
    begin
      </b>DIK8.Unacquire;
      DIK8 := <b>nil</b>;
    <b>end</b>;
    <b>if </b>Assigned(DIM8) <b>then
    begin
      </b>DIM8.Unacquire;
      DIM8 := <b>nil</b>;
    <b>end</b>;
    <b>if </b>Assigned(DIJ8) <b>then
    begin
      </b>DIJ8.Unacquire;
      DIJ8 := <b>nil</b>;
    <b>end</b>;
    DI8 := <b>nil</b>;
  <b>end</b>;
<b>end</b>;

<b>function </b>TInput.InitializeMouse: Boolean;
<b>var
  </b>Prop: TDIPropDWord;
<b>begin
  </b>Result := false;

  DIMButSwapped := GetSystemMetrics(SM_SWAPBUTTON) &lt;&gt; <font color="#000080">0</font>;

  <b>if </b>Failed(DI8.CreateDevice(GUID_SysMouse, DIM8, <b>nil</b>)) <b>then
    </b>Exit;

  <b>if </b>Failed(DIM8.SetDataFormat(@c_dfDIMouse)) <b>then
    </b>Exit;

  <b>if </b>Failed(DIM8.SetCooperativeLevel(Handle, DISCL_FOREGROUND <b>or </b>DISCL_EXCLUSIVE)) <b>then
    </b>Exit;

  DIMEvent := CreateEvent(<b>nil</b>, False, False, <b>nil</b>);
  <b>if </b>DIMEvent = <font color="#000080">0 </font><b>then
    </b>Exit;

  <b>if </b>Failed(DIM8.SetEventNotification(DIMEvent)) <b>then
    </b>Exit;

  <b>with </b>Prop <b>do begin
    </b>diph.dwSize := SizeOf(TDIPropDWord);
    diph.dwHeaderSize := SizeOf(TDIPropHeader);
    diph.dwObj := <font color="#000080">0</font>;
    diph.dwHow := DIPH_DEVICE;
    dwData := DIMBufSize;
  <b>end</b>;

  <b>if </b>Failed(DIM8.SetProperty(DIPROP_BUFFERSIZE, Prop.diph)) <b>then
    </b>Exit;

  Result := True;
<b>end</b>;

<b>function </b>TInput.MouseAcquire(Acquire: Boolean): Boolean;
<b>begin
  if not </b>Acquire <b>then
    </b>Result := <b>not </b>Failed(DIM8.Unacquire)
  <b>else
    </b>Result := <b>not </b>Failed(DIM8.Acquire);
<b>end</b>;

<b>function </b>TInput.MouseState(<b>var </b>X, Y: LongInt; <b>var </b>Up0, Down0, DblClk0,
  Up1, Down1, DblClk1: Longint): Boolean;
<b>var
  </b>Hr: HRESULT;
  Objdata: TDIDeviceObjectData;
  Zero, One: Boolean;
  _Time: DWord;
  Elements: DWord;
<b>begin
  </b>Result := false;

  X := <font color="#000080">0</font>;
  Y := <font color="#000080">0</font>;
  Up0 := <font color="#000080">0</font>;
  Down0 := <font color="#000080">0</font>;
  DblClk0 := <font color="#000080">0</font>;
  Up1 := <font color="#000080">0</font>;
  Down1 := <font color="#000080">0</font>;
  DblClk1 := <font color="#000080">0</font>;

  <b>repeat
    </b>Elements := <font color="#000080">1</font>;
    Hr := DIM8.GetDeviceData(SizeOf(TDIDeviceObjectData), @Objdata, Elements, <font color="#000080">0</font>);
    <b>if </b>Hr = DIERR_INPUTLOST <b>then
    begin
      </b>Hr := DIM8.Acquire;
      <b>if not </b>Failed(hr) <b>then
        </b>Hr := DIM8.GetDeviceData(SizeOf(TDIDeviceObjectData), @ObjData, Elements, <font color="#000080">0</font>);
    <b>end</b>;

    <b>if </b>(Failed(Hr)) <b>then
      </b>Exit;
    Result := True;
    <b>if </b>(Elements = <font color="#000080">0</font>) <b>then
      </b>Exit;

    Zero := False;
    One := False;
    <b>case </b>ObjData.dwOfs <b>of
      </b>DIMOFS_X: X := X + LongInt(ObjData.dwData);
      DIMOFS_Y: Y := Y + LongInt(ObjData.dwData);
      DIMOFS_BUTTON0: <b>if </b>DIMButSwapped <b>then
          </b>One := True
        <b>else
          </b>Zero := True;
      DIMOFS_BUTTON1: <b>if </b>DIMButSwapped <b>then
          </b>Zero := True
        <b>else
          </b>One := True;
    <b>end</b>;

    <b>if </b>Zero <b>then
    begin
      </b>DIMou0Clicked := (ObjData.dwData <b>and </b><font color="#000080">$80 </font>= <font color="#000080">$80</font>);
      <b>if not </b>DIMou0Clicked <b>then
      begin
        </b>Inc(Up0);

        _Time := GetTickCount;
        <b>if </b>(_Time - DIM0Released &lt; DIMTimeOut) <b>then
        begin
          </b>DIM0Released := <font color="#000080">0</font>;
          Inc(DblClk0);
        <b>end
        else
          </b>DIM0Released := _time;
      <b>end
      else
        </b>Inc(Down0);
    <b>end</b>;

    <b>if </b>One <b>then
    begin
      </b>DIMou1Clicked := (ObjData.dwData <b>and </b><font color="#000080">$80 </font>= <font color="#000080">$80</font>);
      <b>if not </b>DIMou1Clicked <b>then
      begin
        </b>Inc(Up1);

        _Time := GetTickCount;
        <b>if </b>(_Time - DIM1Released &lt; DIMTimeOut) <b>then
        begin
          </b>DIM1Released := <font color="#000080">0</font>;
          Inc(DblClk1);
        <b>end
        else
          </b>DIM1Released := _Time;
      <b>end
      else
        </b>Inc(Down1);
    <b>end</b>;
  <b>until </b>Elements = <font color="#000080">0</font>;
<b>end</b>;

<b>function </b>TInput.EnumJoysticksCallback(Device: PDIDeviceInstance; Ref: Pointer): Integer;
<b>begin
  </b>Result := DIENUM_CONTINUE;
  <b>if </b>Failed(DI8.CreateDevice(Device.guidInstance, DIJ8, <b>nil</b>)) <b>then
    </b>Exit;
  Result := DIENUM_STOP;
<b>end</b>;

<b>function </b>TInput.EnumAxesCallback(<b>var </b>Device: TDIDeviceObjectInstance; Ref: Pointer): Integer;
<b>var
  </b>PropRange: TDIPropRange;
<b>begin
  </b>Result := DIENUM_CONTINUE;

  PropRange.diph.dwSize := Sizeof(TDIPropRange);
  PropRange.diph.dwHeaderSize := Sizeof(TDIPropHeader);
  PropRange.diph.dwHow := DIPH_BYID;
  PropRange.diph.dwObj := Device.dwType;
  PropRange.lMin := -DIJoyRange;
  PropRange.lMax := DIJoyRange;

  <b>if </b>Failed(DIJ8.SetProperty(DIPROP_RANGE, PropRange.diph)) <b>then
    </b>Result := DIENUM_STOP;
<b>end</b>;

<b>function </b>TInput.InitializeJoystick: Boolean;
<b>begin
  </b>Result := False;

  DI8.EnumDevices(DI8DEVCLASS_GAMECTRL, @GlobalEnumJoysticksCallback, <b>nil</b>, DIEDFL_ATTACHEDONLY);
  <b>if </b>DIJ8 = <b>nil then
    </b>Exit;

  <b>if </b>Failed(DIJ8.SetDataFormat(@c_dfDIJoystick2)) <b>then
  begin
    </b>DIJ8 := <b>nil</b>;
    Exit;
  <b>end</b>;

  <b>if </b>Failed(DIJ8.SetCooperativeLevel(Handle, DISCL_EXCLUSIVE <b>or </b>DISCL_FOREGROUND)) <b>then
  begin
    </b>DIJ8 := <b>nil</b>;
    Exit;
  <b>end</b>;

  DIJ8CAPS.dwSize := Sizeof(TDIDevCaps);
  <b>if </b>Failed(DIJ8.GetCapabilities(DIJ8CAPS)) <b>then
  begin
    </b>DIJ8 := <b>nil</b>;
    Exit;
  <b>end</b>;

  <b>if </b>Failed(DIJ8.EnumObjects(GlobalEnumAxesCallback, <b>nil</b>, DIDFT_AXIS)) <b>then
  begin
    </b>DIJ8 := <b>nil</b>;
    Exit;
  <b>end</b>;

  Result := True;
<b>end</b>;

<b>function </b>TInput.JoystickState(<b>var </b>Data: TDIJoyState2): Boolean;
<b>begin
  </b>Result := False;

  <b>if </b>Failed(DIJ8.Poll) <b>then
    if </b>DIJ8.Acquire = DIERR_INPUTLOST <b>then
      if </b>Failed(DIJ8.Acquire) <b>then
        </b>Exit;

  Result := <b>not </b>Failed(DIJ8.GetDeviceState(Sizeof(TDIJoyState2), @Data));
<b>end</b>;

<b>function </b>TInput.InitializeKeyboard: Boolean;
<b>begin
  </b>Result := False;

  <b>if </b>Failed(DI8.CreateDevice(GUID_SysKeyboard, DIK8, <b>nil</b>)) <b>then
    </b>Exit;

  <b>if </b>Failed(DIK8.SetDataFormat(@c_dfDIKeyboard)) <b>then
    </b>Exit;

  <b>if </b>Failed(DIK8.SetCooperativeLevel(Handle, DISCL_FOREGROUND <b>or </b>DISCL_NONEXCLUSIVE)) <b>then
    </b>Exit;

  Result := True;
<b>end</b>;

<b>function </b>TInput.KeyboardAcquire(Acquire: Boolean): Boolean;
<b>var
  </b>Hr: hResult;
<b>begin
  if not </b>Acquire <b>then
    </b>Result := <b>not </b>Failed(DIK8.Unacquire)
  <b>else
    </b>Result := <b>not </b>Failed(DIK8.Acquire);
<b>end</b>;

<b>function </b>TInput.KeyboardState: Boolean;
<b>var
  </b>Hr: HRESULT;
<b>begin
  </b>Hr := DIK8.GetDeviceState(SizeOf(DIKeyBuffer), @DIKeyBuffer);

  <b>if </b>Hr = DIERR_INPUTLOST <b>then
  begin
    </b>Hr := DIK8.Acquire;
    <b>if not </b>Failed(Hr) <b>then
      </b>Hr := DIK8.GetDeviceState(SizeOf(DIKeyBuffer), @DIKeyBuffer);
  <b>end</b>;

  Result := <b>not </b>Failed(Hr);
<b>end</b>;

<b>function </b>TInput.KeyDown(Key: Byte): Boolean;
<b>begin
  </b>Result := (DIKeyBuffer[Key] <b>and </b><font color="#000080">$80 </font>= <font color="#000080">$80</font>);
<b>end</b>;

<b>begin
  </b>ZeroMemory(@DIKeyBuffer, SizeOf(DIKeyBuffer));
<b>end</b>.

</font>
</code></pre>
</body>
</html>