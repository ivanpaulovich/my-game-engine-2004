<html>
<head>
<title>brSound.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=3 face="Courier New"><font color="#000080"><i>(*******************************************************)
(*                                                     *)
(*       Engine Paulovich DirectX                      *)
(*       Win32-DirectX API Unit                        *)
(*                                                     *)
(*       Copyright (c) 2003-2004, Ivan Paulovich       *)
(*                                                     *)
(*       iskatrek@hotmail.com  uin#89160524            *)
(*                                                     *)
(*       Unit: brSound                                 *)
(*                                                     *)
(*******************************************************)

</i></font><b>unit </b>brSound;

<b>interface

uses
  </b>Windows, Classes, SysUtils, ActiveX, DirectMusic, DXUtil;

<b>const
  </b>SOUNDERROR_MUSICLOADER = <font color="#000080">$85000001</font>;
  SOUNDERROR_MUSICPERFORMANCE = <font color="#000080">$85000002</font>;
  SOUNDERROR_INITAUDIO = <font color="#000080">$85000003</font>;
  SOUNDERROR_PATH = <font color="#000080">$85000004</font>;
  SOUNDERROR_VOLUME = <font color="#000080">$85000005</font>;
  SOUNDERROR_LOAD = <font color="#000080">$85000006</font>;
  SOUNDERROR_DOWNLOAD = <font color="#000080">$85000007</font>;
  SOUNDERROR_NOSEGMENT = <font color="#000080">$85000008</font>;
  SOUNDERROR_PLAYFAIL = <font color="#000080">$85000009</font>;

<b>type

  </b><font color="#000080"><i>(* TSound *)

  </i></font>PSound = ^TSound;
  TSound = <b>class</b>(TCollectionItem)
  <b>private
    </b>FName: <b>string</b>[<font color="#000080">255</font>];
    FFileName: <b>string</b>[<font color="#000080">255</font>];
    FSound: IDirectMusicSegment8;
    FLoader: IDirectMusicLoader8;
    FPerformance: IDirectMusicPerformance8;
    <b>function </b>InitSoundSystem: HRESULT;
    <b>function </b>GetName: <b>string</b>;
    <b>procedure </b>SetName(Value: <b>string</b>);
    <b>function </b>GetFileName: <b>string</b>;
    <b>procedure </b>SetFileName(Value: <b>string</b>);
  <b>public
    constructor </b>Create(Collection: TCollection); <b>override</b>;
    <b>destructor </b>Destroy;
    <b>function </b>LoadFromFile(FileSound: <b>string</b>): Boolean;
    <b>function </b>Play: Boolean;
    <b>function </b>Stop: Boolean;
    <b>property </b>Name: <b>string read </b>GetName <b>write </b>SetName;
    <b>property </b>FileName: <b>string read </b>GetFileName <b>write </b>SetFileName;
  <b>end</b>;

  <font color="#000080"><i>(* TSounds *)

  </i></font>TSounds = <b>class</b>(TCollection)
  <b>private
    function </b>IndexOf(Name: <b>string</b>): TSound;
    <b>function </b>GetItem(Index: Integer): TSound;
  <b>public
    function </b>Add: TSound;
    <b>function </b>AddEx(FileName: <b>string</b>; Name: <b>string</b>): TSound;
    <b>function </b>Find(<b>const </b>Name: <b>string</b>): TSound;
    <b>property </b>Item[<b>Index</b>: Integer]: TSound <b>read </b>GetItem;
  <b>end</b>;

<b>implementation

uses
  </b>brForms;

<b>var
  </b>Initialized: Boolean = False;
  
<b>constructor </b>TSound.Create;
<b>begin
  inherited </b>Create(Collection);

  FSound := <b>nil</b>;
  FLoader := <b>nil</b>;
  FPerformance := <b>nil</b>;
  <b>if not </b>Initialized <b>then
    </b>InitSoundSystem;
<b>end</b>;

<b>destructor </b>TSound.Destroy;
<b>begin
  if </b>Assigned(FSound) <b>then
    if </b>Assigned(FPerformance) <b>then
      </b>FSound.Unload(FPerformance);

  FSound := <b>nil</b>;
  FLoader := <b>nil</b>;
  FPerformance := <b>nil</b>;
<b>end</b>;

<b>function </b>TSound.InitSoundSystem: HRESULT;
<b>var
  </b>FPath: IDirectMusicAudioPath8;
<b>begin
  </b>CoInitialize(<b>nil</b>);

  <b>if </b>(Failed(CoCreateInstance(CLSID_DirectMusicLoader, <b>nil</b>,
    CLSCTX_INPROC, IID_IDirectMusicLoader8, FLoader))) <b>then
  begin
    </b>Result := SOUNDERROR_MUSICLOADER;
    Exit;
  <b>end</b>;

  <b>if </b>(Failed(CoCreateInstance(CLSID_DirectMusicPerformance, <b>nil</b>,
    CLSCTX_INPROC, IID_IDirectMusicPerformance8, FPerformance))) <b>then
  begin
    </b>Result := SOUNDERROR_MUSICPERFORMANCE;
    Exit;
  <b>end</b>;

  <b>if </b>(Failed(FPerformance.InitAudio(<b>nil</b>, <b>nil</b>, Window.Handle, DMUS_APATH_DYNAMIC_STEREO,
    <font color="#000080">4</font>, DMUS_AUDIOF_ALL, <b>nil</b>))) <b>then
  begin
    </b>Result := SOUNDERROR_INITAUDIO;
    Exit;
  <b>end</b>;

  <b>if </b>(Failed(FPerformance.GetDefaultAudioPath(FPath))) <b>then
  begin
    </b>Result := SOUNDERROR_PATH;
    Exit;
  <b>end</b>;

  <b>if </b>(Failed(FPath.SetVolume(<font color="#000080">0</font>, <font color="#000080">0</font>))) <b>then
  begin
    </b>Result := SOUNDERROR_VOLUME;
  <b>end</b>;

  Initialized := True;
  Result := S_OK;
<b>end</b>;

<b>function </b>TSound.LoadFromFile(FileSound: <b>string</b>): Boolean;
<b>var
  </b>WFileName: <b>array</b>[<font color="#000080">0</font>..<font color="#000080">511</font>] <b>of </b>WChar;
<b>begin
  </b>Result := False;

  <b>if </b>FileExists(FileSound) <b>then
    </b>SaveLog(Format(EVENT_FOUND, [FileSound]))
  <b>else
    raise </b>EError.Create(Format(ERROR_NOTFOUND, [FileSound]));

  FFileName := FileSound;

  <b>if not </b>Assigned(FLoader) <b>then
  begin
    raise </b>EError.Create(ERROR_MUSICLOADER);
    Exit;
  <b>end</b>;

  <b>if not </b>Assigned(FPerformance) <b>then
  begin
    raise </b>EError.Create(ERROR_MUSICPERFORMANCE);
    Exit;
  <b>end</b>;

  <b>if </b>Assigned(FSound) <b>then
  begin
    </b>FSound.Unload(FPerformance);
    FSound._Release;
    FSound := <b>nil</b>;
  <b>end</b>;

  DXUtil_ConvertGenericStringToWide(WFileName, PChar(FileSound), <font color="#000080">512</font>);

  <b>if </b>(FAILED(FLoader.LoadObjectFromFile(CLSID_DirectMusicSegment, IID_IDirectMusicSegment8,
    WFileName, FSound))) <b>then
  begin
    raise </b>EError.Create(ERROR_LOAD);
    Exit;
  <b>end</b>;

  <b>if </b>(FAILED(FSound.Download(FPerformance))) <b>then
  begin
    raise </b>EError.Create(ERROR_DOWNLOAD);
    Exit;
  <b>end</b>;

  Result := True;
<b>end</b>;

<b>function </b>TSound.Play;
<b>begin
  </b>Result := False;

  <b>if not </b>Assigned(FPerformance) <b>then
  begin
    raise </b>EError.Create(ERROR_MUSICPERFORMANCE);
    Exit;
  <b>end</b>;

  <b>if not </b>Assigned(FSound) <b>then
  begin
    raise </b>EError.Create(ERROR_NOSEGMENT);
    Exit;
  <b>end</b>;

  <b>if </b>Failed(FPerformance.PlaySegment(FSound, DMUS_SEGF_DEFAULT <b>or </b>DMUS_SEGF_SECONDARY, <font color="#000080">0</font>, <b>nil</b>)) <b>then
  begin
    raise </b>EError.Create(ERROR_PLAYFAIL);
    Exit;
  <b>end</b>;

  Result := True;
<b>end</b>;

<b>function </b>TSound.Stop;
<b>begin
  </b>Result := FPerformance.Stop(FSound, <b>nil</b>, <font color="#000080">0</font>, <font color="#000080">0</font>) = S_OK;
<b>end</b>;

<b>function </b>TSound.GetName: <b>string</b>;
<b>begin
  </b>Result := FName;
<b>end</b>;

<b>procedure </b>TSound.SetName(Value: <b>string</b>);
<b>begin
  </b>FName := Value;
<b>end</b>;

<b>function </b>TSound.GetFileName: <b>string</b>;
<b>begin
  </b>Result := FileName;
<b>end</b>;

<b>procedure </b>TSound.SetFileName(Value: <b>string</b>);
<b>begin
  </b>FFileName := Value;
  LoadFromFile(Value);
<b>end</b>;

<b>function </b>TSounds.IndexOf(Name: <b>string</b>): TSound;
<b>var
  </b>I: Integer;
<b>begin
  for </b>I := <font color="#000080">0 </font><b>to </b>Count - <font color="#000080">1 </font><b>do
  begin
    if </b>GetItem(I).Name = Name <b>then
    begin
      </b>Result := GetItem(I);
      Exit;
    <b>end</b>;
  <b>end</b>;

  Result := <b>nil</b>;
<b>end</b>;

<b>function </b>TSounds.GetItem(Index: Integer): TSound;
<b>begin
  </b>Result := <b>inherited </b>Items[Index] <b>as </b>TSound;
<b>end</b>;

<b>function </b>TSounds.Add: TSound;
<b>begin
  </b>Result := <b>inherited </b>Add <b>as </b>TSound;
<b>end</b>;

<b>function </b>TSounds.AddEx(FileName: <b>string</b>; Name: <b>string</b>): TSound;
<b>begin
  </b>Result := <b>inherited </b>Add <b>as </b>TSound;
  Result.Name := Name;
  Result.FFileName := FileName;
  Result.LoadFromFile(FileName);
<b>end</b>;

<b>function </b>TSounds.Find(<b>const </b>Name: <b>string</b>): TSound;
<b>begin
  </b>Result := IndexOf(Name);
  <b>if </b>Result = <b>nil then
    raise </b>EError.Create(Format(ERROR_NOTFOUND, [Name]));
<b>end</b>;

<b>end</b>.
</font>
</code></pre>
</body>
</html>